<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Photo Assassin</title>
    <style>
        /*hack so that elments with display:flex can still be hidden
        https://stackoverflow.com/a/48936804*/
        [hidden]{
            display:none !important;
        }
        #map {
            height: 100%;
            width: 100%;
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-size: 1em;
        }
        .container {
            height: 100%;
            width: 100%;
            position: fixed;
            display: flex;
            flex-direction: column;
        }

        .top {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }

        .middle-2 {
            list-style-type: none;
            overflow-y: auto;
            width: 100%;
            height: 100%;
            flex: 1;
            position: relative;
        }

        #info {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
            background-color: rgba(255, 255, 255, 0.7);
        }

        .options-map-overlay {
            position: absolute;
            left: 0;
            bottom: 0;
            list-style-type: none;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 1em;
            margin: 1em;
        }

        input[type=checkbox] {
            transform: scale(2);
            margin-left: 1em;
        }

        #photo-overlay {
            position: absolute;
            left: 0;
            top: 0;
        }

        #photo {
            width: 100%;
            object-fit: contain;
        }
    </style>
    <script src="https://browser.sentry-cdn.com/5.20.1/bundle.min.js" integrity="sha384-O8HdAJg1h8RARFowXd2J/r5fIWuinSBtjhwQoPesfVILeXzGpJxvyY/77OaPPXUo" crossorigin="anonymous">
    </script>
    <!--should be coded on the assumption that viewer might not be a player-->
    <script>
        // Sentry is on adblocker lists, so we can't depend on it working
        // https://github.com/getsentry/sentry-javascript/issues/668
        if(typeof variable !== 'undefined'){
            Sentry.init({ dsn: 'https://0622ee38668548dcb4af966730298b31@o428868.ingest.sentry.io/5374680' });
            //todo: when we have a build process for this page
            // if(process.env.SENTRY_TESTS == "true"){
            Sentry.captureException(new Error("sentry test archieved.html"));
            //}
        }
        const cookieGameId = decodeURIComponent(document.cookie.replace(/(?:(?:^|.*;\s*)gameId\s*\=\s*([^;]*).*$)|^.*$/, "$1"));

        let urlGameId = window.location.href.split('/').pop()
        let privateId;
        let publicId;
        // we only let users have cookies for one game at a time at the moment
        // so check they're for the current and treat the as observer if not
        if(cookieGameId == urlGameId){
            privateId = document.cookie.replace(/(?:(?:^|.*;\s*)privateId\s*\=\s*([^;]*).*$)|^.*$/, "$1");
            publicId = document.cookie.replace(/(?:(?:^|.*;\s*)publicId\s*\=\s*([^;]*).*$)|^.*$/, "$1");
        }

        function getPlayerColor(playerPublicId){
            //todo: let player choose and store in game
            return playerColours[playerPublicId%playerColours.length];
        }

        let playerEmojis = [
            "😀",
            "😗",
            "🕶",
            "🐵",
            "🐶",
            "🦄",
            "🦋",
            "🐌",
            "🦠",
            "🦃",
            "🦆",
            "🦉",
            "🦜",
            "🐋",
            "🐡",
            "🦈",
            "🐙",
            "🌻",
            "🌵",
            "☘"
        ];

        function getPlayerEmoji(playerPublicId){
            //todo: let player choose and store in game
            return playerEmojis[playerPublicId%playerEmojis.length];
        }

        var gameState;
        const getData = async () => {
            const response = await fetch(window.location.href + "?format=json");
            gameState = await response.json();
            console.log(gameState);
            setUpPage(gameState);
            initMap();
            annotateMap();
        }

        function setUpPage(gameState) {
            if(publicId){
                const username = gameState.userList[publicId].username;
                document.getElementById("username").innerText = username;
            }else{
                document.getElementById("username").innerText = "observer";
            }
            if (gameState.userList[gameState.winner]) {
                document.getElementById('game-result').innerText = gameState.userList[gameState.winner].username;
            } else {
                document.getElementById('game-result').innerText = gameState.winner;
            }
            var targetsState = document.getElementById('targets-state');
            for (var key of Object.keys(gameState.targets)) {
                var outerLi = document.createElement('li');
                var ul = document.createElement('ul');
                var innerLi = document.createElement('li');
                innerLi.innerText = gameState.userList[key].username
                outerLi.appendChild(innerLi);
                outerLi.appendChild(ul);
                var innerLi = document.createElement('li');
                innerLi.innerText = "got " + gameState.targetsGot[key].map(x => gameState.userList[x].username).join(" -> ");
                ul.appendChild(innerLi);

                var innerLi = document.createElement('li');
                innerLi.innerText = "left: " + gameState.targets[key].map(x => gameState.userList[x].username).join(" -> ");
                ul.appendChild(innerLi);
                targetsState.appendChild(outerLi);
            }
            if(publicId){
                const username = gameState.userList[publicId].username;
                console.log(username)
                document.getElementById('next-game-link').setAttribute('href', `/?code=${gameState.nextCode}&username=${username}`);
            }else{
                document.getElementById('next-game-link').hidden = true
            }

            var options = document.getElementById("options");
            for(const [playerPublicId, player] of Object.entries(gameState.userList)){
                var labelItem = document.createElement("li");
                let inputId = `show-player-${player.username}`
                var label = document.createElement("label");
                label.innerText = player.username;
                label.setAttribute('for', inputId)
                let playerColour = getPlayerColor(playerPublicId);
                label.setAttribute('style', `background-color: ${playerColour}`);
                options.appendChild(label);
                var input = document.createElement("input");
                input.setAttribute("type", "checkbox");
                input.setAttribute("checked", true);
                input.addEventListener('change', () => {
                    annotateMap();
                });
                input.setAttribute("id", inputId);
                labelItem.appendChild(label);
                labelItem.appendChild(input);
                options.appendChild(labelItem);
            }
        }

        window.onload = function () {
            getData();
            document.getElementById('show-map').onclick = function(){
                document.getElementById('info').hidden = !document.getElementById('info').hidden;
                document.getElementById('options').hidden = !document.getElementById('options').hidden;
                if(!document.getElementById('map').hidden){
                    map.setOptions({
                        zoomControl: true,
                        gestureHandling: 'greedy',
                        // changing the option doesn't seem to quite be working
                        // disableDefaultUI: false,
                    });
                }else{
                    document.getElementById('options').hidden = true;
                    map.setOptions({
                        zoomControl: false,
                        gestureHandling: 'none',
                        // disableDefaultUI: true,
                    });
                }
            }
            document.getElementById('photo-back').onclick = function(){
                document.getElementById('photo-div').hidden = true;
                document.getElementById('main').hidden = false;
                document.getElementById('photo').src = window.location.href + "/shitty_loader.jpg";

            }
        };

        var mapData = {
            "playerPaths": [],
            "playerSnipes": [],
        };

        // hardcode distinct colours, and reuse if too many players
        // todo: find a js library to handle colour generation
        var playerColours = [
            "#FFB300",  //Vivid Yellow
            "#803E75",  //Strong Purple
            "#FF6800",  //Vivid Orange
            "#A6BDD7",  //Very Light Blue
            "#C10020",  //Vivid Red
            "#CEA262",  //Grayish Yellow
            "#817066",  //Medium Gray

            // The following don't work well for people with defective color vision
            "#007D34",  //Vivid Green
            "#F6768E",  //Strong Purplish Pink
            "#00538A",  //Strong Blue
            "#FF7A5C",  //Strong Yellowish Pink
            "#53377A",  //Strong Violet
            "#FF8E00",  //Vivid Orange Yellow
            "#B32851",  //Strong Purplish Red
            "#F4C800",  //Vivid Greenish Yellow
            "#7F180D",  //Strong Reddish Brown
            "#93AA00",  //Vivid Yellowish Green
            "#593315",  //Deep Yellowish Brown
            "#F13A13",  //Vivid Reddish Orange
            "#232C16",  //Dark Olive Green
        ];

        function prepareMapData(gameState){
            for(const [playerPublicId, player] of Object.entries(gameState.userList)){
                var path = [];
                mapData["playerSnipes"][playerPublicId] = [];
                for(var position of gameState.positions[playerPublicId]){
                    var latlng = {lat: position.latitude, lng: position.longitude};
                    path.push(latlng);
                }
                var polyLine = new google.maps.Polyline({
                    path: path,
                    geodesic: true,
                    strokeColor: getPlayerColor(playerPublicId),
                    strokeOpacity: 1.0,
                    strokeWeight: 2
                });
                if(gameState.imageMetadata[playerPublicId]){
                    for(const [index, metadata] of gameState.imageMetadata[playerPublicId].entries()){
                        let title = `Picture by ${sniper}`
                        if(metadata["snipeNumber"] != undefined){
                            var sniper = gameState.userList[playerPublicId].username;
                            //todo: simplify snipe number - its complex and stupid
                            let totalTargets = gameState.targetsGot[playerPublicId].length + gameState.targets[playerPublicId].length
                            let targetIndex = totalTargets - metadata["snipeNumber"]
                            var target = gameState.userList[gameState.targetsGot[playerPublicId][targetIndex]].username;
                            title = `${sniper} got ${target}`
                        }
                        var latlng = {lat: metadata.position.latitude, lng: metadata.position.longitude};
                        var marker = new google.maps.Marker({
                            position: latlng,
                            title: title
                        });
                        marker.addListener('click', function() {
                            document.getElementById('photo-div').hidden = false;
                            document.getElementById('main').hidden = true;
                            document.getElementById('photo-text').innerText = title;
                            document.getElementById('photo').src = window.location.href + "?format=json&publicId="+playerPublicId+"&index="+index;
                        });

                        var obj = {"marker": marker};

                        if(metadata["targetPosition"]){
                            var lineSymbol = {
                                path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW
                            };
                            var targetLatLng = {
                                lat: metadata["targetPosition"].latitude,
                                lng: metadata["targetPosition"].longitude,
                            };
                            var arrow = new google.maps.Polyline({
                                path: [latlng, targetLatLng],
                                icons: [{
                                    icon: lineSymbol,
                                    offset: '100%'
                                }],
                            });
                            obj["arrow"] = arrow;
                        }
                        mapData["playerSnipes"][playerPublicId].push(obj);
                    }
                }
                //todo: this is undefined if player never sends position and so explodes
                //in annotation
                mapData["playerPaths"][playerPublicId] = polyLine;
            }
        }

        var map;

        function annotateMap(){
            // it's more efficient if we just add/remove the relevant bits when
            // for a specific option that's been changed
            // but this is more flexable for now

            for(const [playerPublicId, player] of Object.entries(gameState.userList)){
                var checkbox = document.getElementById(`show-player-${player.username}`);
                if(checkbox.checked){
                    mapData["playerPaths"][playerPublicId].setMap(map);
                    for(var snipe of mapData["playerSnipes"][playerPublicId]){
                        snipe["marker"].setMap(map);
                        //this might not be set if the target never sent a position
                        if(snipe["arrow"]){
                            snipe["arrow"].setMap(map);
                        }
                    }
                }else{
                    mapData["playerPaths"][playerPublicId].setMap(null);
                    for(var snipe of mapData["playerSnipes"][playerPublicId]){
                        snipe["marker"].setMap(null);
                        if(snipe["arrow"]){
                            snipe["arrow"].setMap(null);
                        }
                    }
                }
            }
            //center on when they started
            //instead we should capture the agreed starting point of the game and use that
            //current approach also breaks for observers without a publicId
            if(publicId){
                map.setCenter(mapData["playerPaths"][publicId].getPath().getAt(0));
            }else{
                map.setCenter(mapData["playerPaths"][0].getPath().getAt(0));
            }
        }

        var ready = false;
        function initMap() {
            //hack to check that both google maps is loaded
            // and game data has been fetched
            if (!ready) {
                ready = true;
                return;
            }

            prepareMapData(gameState);

            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 17,
                mapTypeId: 'satellite',
            });
        }
    </script>
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDpVE1utBPfvtw9Y0b6LVAIWBJGxr7POUQ&callback=initMap">
        </script>
</head>

<body>
    <div class="container" id="main">
        <div class="top">
            <p id="username" style="grid-column: 1;grid-row: 1;"></p>
            <button id="show-map" style="grid-column: 2;grid-row: 1;">Map</button>
            <!--having this seems useful even for historic games
        lets you trace the order games were player in-->
            <a id="next-game-link" style="grid-column: 3;grid-row: 1;">Next game</a>
        </div>
        <div class="middle-2">
            <div id="map"></div>
            <div id="info">
                <h2>Winner</h2>
                <p id="game-result"></p>
                <ul id="targets-state"></ul>
            </div>
            <ul id="options" class="options-map-overlay" hidden>
                <!--insert checkboxes for each player in the game-->
            </ul>
        </div>
    </div>
    <div id="photo-div" hidden>
        <div id="photo-overlay">
            <button id="photo-back">Back</button>
            <p id="photo-text"></p>
        </div>
        <img id="photo"></img>
    </div>
</body>

</html>