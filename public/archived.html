<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>Photo Assassin</title>
    <style>
        #map {
            height: 100%;
            width: 100%;
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        .container {
            font-size: 2em;
            height: 100%;
            width: 100%;
            position: fixed;
            display: flex;
            flex-direction: column;
        }
        /* p h2 ul {
            text-align: center;
        } */

        button, input, label[type=text], textarea {
            font-size: 150%;
        }
        .top {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }

        .middle-2 {
            list-style-type: none;
            overflow-y: auto;
            width: 100%;
            height: 100%;
            flex: 1;
            display: flex;
            flex-direction: row;
        }
    </style>
    <script src="https://browser.sentry-cdn.com/5.20.1/bundle.min.js" integrity="sha384-O8HdAJg1h8RARFowXd2J/r5fIWuinSBtjhwQoPesfVILeXzGpJxvyY/77OaPPXUo" crossorigin="anonymous">
    </script>
    <!--should be coded on the assumption that viewer might not be a player-->
    <script>
        Sentry.init({ dsn: 'https://0622ee38668548dcb4af966730298b31@o428868.ingest.sentry.io/5374680' });
        const gameId = decodeURIComponent(document.cookie.replace(/(?:(?:^|.*;\s*)gameId\s*\=\s*([^;]*).*$)|^.*$/, "$1"));
        console.log(gameId);
        const privateId = document.cookie.replace(/(?:(?:^|.*;\s*)privateId\s*\=\s*([^;]*).*$)|^.*$/, "$1");
        const publicId = document.cookie.replace(/(?:(?:^|.*;\s*)publicId\s*\=\s*([^;]*).*$)|^.*$/, "$1");

        var gameState;
        const getData = async () => {
            const response = await fetch(window.location.href + "?format=json");
            gameState = await response.json();
            console.log(gameState);
            setUpPage(gameState);
            initMap();
        }

        function setUpPage(gameState) {
            const username = gameState.userList[publicId].username;
            document.getElementById("username").innerText = username;
            if (gameState.userList[gameState.winner]) {
                document.getElementById('game-result').innerText = gameState.userList[gameState.winner].username;
            } else {
                document.getElementById('game-result').innerText = gameState.winner;
            }
            var targetsState = document.getElementById('targets-state');
            for (var key of Object.keys(gameState.targets)) {
                var outerLi = document.createElement('li');
                var ul = document.createElement('ul');
                var innerLi = document.createElement('li');
                innerLi.innerText = gameState.userList[key].username
                outerLi.appendChild(innerLi);
                outerLi.appendChild(ul);
                var innerLi = document.createElement('li');
                innerLi.innerText = "got " + gameState.targetsGot[key].map(x => gameState.userList[x].username).join(" -> ");
                ul.appendChild(innerLi);

                var innerLi = document.createElement('li');
                innerLi.innerText = "left: " + gameState.targets[key].map(x => gameState.userList[x].username).join(" -> ");
                ul.appendChild(innerLi);
                targetsState.appendChild(outerLi);
            }
            document.getElementById('next-game-link').setAttribute('href', `/?code=${gameState.nextCode}&username=${username}`);

            var options = document.getElementById("options");
            for(const [playerPublicId, player] of Object.entries(gameState.userList)){
                var input = document.createElement("input");
                input.setAttribute("type", "checkbox");
                input.setAttribute("checked", true);
                input.setAttribute("id", `show-player-${player.username}`);
                var label = document.createElement("label");
                label.innerText = player.username;
                label.appendChild(input);
                options.appendChild(label);
            }
        }

        window.onload = function () {
            getData();
            document.getElementById('show-map').onclick = function(){
                document.getElementById('info').hidden = !document.getElementById('info').hidden;
                document.getElementById('options').hidden = !document.getElementById('options').hidden;
                document.getElementById('map').hidden = !document.getElementById('map').hidden;
                if(!document.getElementById('map').hidden){
                    annotateMap();
                }
            }
        };

        var mapData = {
            "playerPaths": [],
            "playerSnipes": [],
        };

        // hardcode distinct colours, and reuse if too many players
        // todo: find a js library to handle colour generation
        var playerColours = [
            "#FFB300",  //Vivid Yellow
            "#803E75",  //Strong Purple
            "#FF6800",  //Vivid Orange
            "#A6BDD7",  //Very Light Blue
            "#C10020",  //Vivid Red
            "#CEA262",  //Grayish Yellow
            "#817066",  //Medium Gray

            // The following don't work well for people with defective color vision
            "#007D34",  //Vivid Green
            "#F6768E",  //Strong Purplish Pink
            "#00538A",  //Strong Blue
            "#FF7A5C",  //Strong Yellowish Pink
            "#53377A",  //Strong Violet
            "#FF8E00",  //Vivid Orange Yellow
            "#B32851",  //Strong Purplish Red
            "#F4C800",  //Vivid Greenish Yellow
            "#7F180D",  //Strong Reddish Brown
            "#93AA00",  //Vivid Yellowish Green
            "#593315",  //Deep Yellowish Brown
            "#F13A13",  //Vivid Reddish Orange
            "#232C16",  //Dark Olive Green
        ];

        function prepareMapData(gameState){
            for(const [playerPublicId, player] of Object.entries(gameState.userList)){
                console.log(gameState.positions[publicId]);
                var path = [];
                mapData["playerSnipes"][playerPublicId] = [];
                for(var position of gameState.positions[playerPublicId]){
                    var latlng = {lat: position.latitude, lng: position.longitude};
                    path.push(latlng);
                    if(position["snipeInfo"]){
                        var sniper = gameState.userList[playerPublicId].username;
                        var target = gameState.userList[position["snipeInfo"]["target"]].username;
                        var marker = new google.maps.Marker({position: latlng, title: `${sniper} got ${target}`});

                        var obj = {"marker": marker};

                        //this can fail if target play didnt send a position all game
                        if(position["snipeInfo"]["targetPosition"]){
                            var lineSymbol = {
                                path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW
                            };
                            var targetLatLng = {
                                lat: position["snipeInfo"]["targetPosition"].latitude,
                                lng: position["snipeInfo"]["targetPosition"].longitude,
                            };
                            var arrow = new google.maps.Polyline({
                                path: [latlng, targetLatLng],
                                icons: [{
                                    icon: lineSymbol,
                                    offset: '100%'
                                }],
                            });
                            obj["arrow"] = arrow;
                        }
                        mapData["playerSnipes"][playerPublicId].push(obj);
                    }
                }
                var polyLine = new google.maps.Polyline({
                    path: path,
                    geodesic: true,
                    strokeColor: playerColours[playerPublicId%playerColours.length],
                    strokeOpacity: 1.0,
                    strokeWeight: 2
                });
                //todo: this is undefined if player never sends position and so explodes
                //in annotation
                mapData["playerPaths"][playerPublicId] = polyLine;
            }
        }

        var map;

        function annotateMap(){
            // it's more efficient if we just add/remove the relevant bits when
            // for a specific option that's been changed
            // but this is more flexable for now

            for(const [playerPublicId, player] of Object.entries(gameState.userList)){
                var checkbox = document.getElementById(`show-player-${player.username}`);
                if(checkbox.checked){
                    mapData["playerPaths"][playerPublicId].setMap(map);
                    for(var snipe of mapData["playerSnipes"][playerPublicId]){
                        snipe["marker"].setMap(map);
                        snipe["arrow"].setMap(map);
                    }
                }else{
                    mapData["playerPaths"][playerPublicId].setMap(null);
                    for(var snipe of mapData["playerSnipes"][playerPublicId]){
                        snipe["marker"].setMap(null);
                        snipe["arrow"].setMap(null);
                    }
                }
            }
            //center on when they started
            //instead we should capture the agreed starting point of the game and use that
            //current approach also breaks for observers without a publicId
            map.setCenter(mapData["playerPaths"][publicId].getPath().getAt(0));
        }

        var ready = false;
        function initMap() {
            //hack to check that both google maps is loaded
            // and game data has been fetched
            console.log("called");
            if (!ready) {
                console.log("not ready");
                ready = true;
                return;
            }

            prepareMapData(gameState);

            for(var i of gameState.positions[publicId]){
                var item = document.createElement('li');
                item.innerText = JSON.stringify(i);
                document.getElementById("positions").appendChild(item);
            }

            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 17,
                mapTypeId: 'satellite'
            });
        }
    </script>
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDpVE1utBPfvtw9Y0b6LVAIWBJGxr7POUQ&callback=initMap">
        </script>
</head>

<body>
    <div class="container" id="not-started" hidden>
        <div class="top">
            <p id="username" style="grid-column: 1;grid-row: 1;"></p>
            <button id="show-map" style="grid-column: 2;grid-row: 1;">Map</button>
            <!--having this seems useful even for historic games
        lets you trace the order games were player in-->
            <a id="next-game-link" style="grid-column: 3;grid-row: 1;">Next game</a>
        </div>
        <div class="middle-2">
            <div id="info" style="flex: 1;">
                <h2>Winner</h2>
                <p id="game-result"></p>
                <ul id="targets-state"></ul>
                <h3>debug data</h3>
                <ul id="positions"></ul>
            </div>
            <div id="options" style="flex: 1;">
                <!--insert checkboxes for each player in the game-->
            </div>
            <div id="map" hidden></div>
        </div>
    </div>
</body>

</html>