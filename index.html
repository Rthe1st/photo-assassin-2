<!doctype html>
<html>
  <head>
    <title>Photo Assassin</title>
    <style>
      body {
        font-size: 2em;
        height: 100%;
        width: 100%;
        position: fixed;
        display:flex;
        flex-direction:column;
      }
      #messages {
        list-style-type: none;
        overflow-y: auto;
        width:100%;
        height: 100%;
        flex:1;
        }
      form {
        /* display: table; */
        background: #4eb7e7;
        /*width: 100%;*/
        /* position: fixed; */
        /*bottom: 0;*/
      }
      #messages li:nth-child(odd) { background: #eee; }
      .username {
        font-weight: bold;
      }
      #message {
        width: 100%;
      }

      button, input, label[type=text], textarea {
        font-size: 150%;
      }

      button, label, textarea {
        display: block;
      }

      img {
        width: 80vw;
        height: 80vw;
        object-fit: cover; /* Do not scale the image */
        object-position: center; /* Center the image within the element */
      }
      input[type=checkbox] {
        transform: scale(3);
      }

      #send-message-form {
        display:flex;
        flex-direction:row;
      }

    </style>
  </head>
  <body>
    <!--todo: use semantic elements-->
    <p id="username"></p>
    <div id="not-started">
      <button id="make-targets">Make targets</button>
    </div>
    <div id="targets-made" hidden>
        <button id="start-game">Start</button>
        <!-- todo: this is has 2 potential uses
        1) regen target lists people don't like
        2) include later users in the target list-->
        <!--<button id="make-targets">Re-make targets</button>-->
        <p>Targets</p>
        <ul id="targets"></ul>
        <label>Game Length (in seconds)<input id="game-length"></label>
    </div>
    <div id="in-play" hidden>
        <p id="time-left"></p>
        <button id="stop-game">Stop</button>
        <p id="target"></p>
    </div>
    <ul id="messages"></ul>
    <form id="send-message-form" action="">
      <textarea id="message" placeholder="Type a message"></textarea>
      <label>Snipe?
        <input id="is-snipe" type="checkbox"/>
      </label>
      <button id="send-message">Send</button>
      <button id="camera-button">Camera</button>
      <input hidden id="photo" type="file" accept="image/*" capture="capture">
    </form>
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
      var position = {latitude: null, longitude: null};
      function updatePosition(geolocation){
        position.latitude = geolocation.coords.latitude;
        position.longitude = geolocation.coords.longitude;
      }
      function dontUpdatePosition(a){
        console.log("geo loc failed");
        console.log(a);
      }

      function targetDisplay(targets){
        users = Object.keys(targets);
        output = "";
        for(var i=0; i<users.length;i++){
          output += users[i] + "-> " + targets[users[i]] + "\n";
        }
        return output
      }

      function createChatElement(username, message, image){
        var li = document.createElement('li');
        var span = document.createElement('span');
        span.innerText = username;
        
        span.classList.add("username");
        li.appendChild(span);
        paragraph = document.createElement('p');
        paragraph.innerText = message;
        li.appendChild(paragraph);
        if(image){
          var blob = new Blob([image], {type: 'image/png'});
          var url = URL.createObjectURL(blob);
          var img = new Image;
          var canvas = document.createElement('canvas');
          img.src = url;
          li.appendChild(img);
        }
        document.getElementById('messages').appendChild(li);
      }

      function loadChatHistory(gameId){
        var gameChatStorage = window.localStorage.getItem(gameId);
        gameChatStorage = JSON.parse(gameChatStorage);
        console.log(gameChatStorage);
        if(gameChatStorage){
          for(var i=0; i<gameChatStorage.length; i++){
            createChatElement(gameChatStorage[i]["username"], gameChatStorage[i]["message"]);
          }
        }
      }

      function newMessageEntry(gameId, username, message, image){
        createChatElement(username, message, image);

        //todo: save server side as well
        //todo: work out how to deal with images better
        // without blowing storage limit
        //todo: when we're close to limit, kick out old messages
        var gameChatStorage = window.localStorage.getItem(gameId);
        if(gameChatStorage == null){
          gameChatStorage = [];
        }else{
          gameChatStorage = JSON.parse(gameChatStorage);
        }
        gameChatStorage.push({"username": username, "message": message});
        window.localStorage.setItem(gameId, JSON.stringify(gameChatStorage));
      }

      window.onload = function () {

        document.getElementById("camera-button").addEventListener('click', function(ev){
          document.getElementById('photo').click();
          ev.preventDefault();
        });

        navigator.geolocation.watchPosition(
          updatePosition,
          dontUpdatePosition,
          {"enableHighAccuracy": true}
        );

        // gameId needs to be decoded because it contains a '/'
        // which gets URI encoded otherwise
        var gameId = decodeURIComponent(document.cookie.replace(/(?:(?:^|.*;\s*)gameId\s*\=\s*([^;]*).*$)|^.*$/, "$1"));
        var privateId = document.cookie.replace(/(?:(?:^|.*;\s*)privateId\s*\=\s*([^;]*).*$)|^.*$/, "$1");
        var publicId = document.cookie.replace(/(?:(?:^|.*;\s*)publicId\s*\=\s*([^;]*).*$)|^.*$/, "$1");
        console.log(gameId);

        loadChatHistory(gameId);

        const socket = io(
          // leading slash is needed so IO nows we're giving it a path
          // otherwise it uses it as a domain
          `/${gameId}`,
          {
            query: {
              "privateId": privateId,
            }
          }
        );

        document.getElementById('send-message-form').addEventListener('submit', function(){
          var file = document.getElementById('photo').files[0];
          message = {
            "text": document.getElementById('message').value,
            "image": file,
            "position": position,
            "isSnipe": document.getElementById('is-snipe').checked,
          }
          socket.emit('chat message', message);
          document.getElementById('message').value = '';
          document.getElementById('photo').value = '';
          document.getElementById('is-snipe').checked = false;
          return false;
        });

        function processGameStateChange(gameState){
          // this really only needs to be done once when we first recieve game state
          document.getElementById('username').innerText = gameState.userList[publicId].username;
          //console.log(gameState);
          if(gameState.state == TARGETS_MADE){
            document.getElementById('targets-made').hidden = false;
            document.getElementById('not-started').hidden = true;
            document.getElementById('in-play').hidden = true;
            console.log(targetDisplay(gameState.targets));

            var targetsElement = document.getElementById('targets');
            targetsElement.innerHTML = '';
            for(var key of Object.keys(gameState.targets)){
              var element = document.createElement('li');
              var text = gameState.userList[key].username + "->" + gameState.userList[gameState.targets[key]].username;
              element.innerText = text;
              targetsElement.appendChild(element);
            }
          }
          if(gameState.state ==  NOT_STARTED){
            document.getElementById('targets-made').hidden = true;
            document.getElementById('not-started').hidden = false;
            document.getElementById('in-play').hidden = true;
            console.log("winner was " + gameState.winner);
          }
          if(gameState.state == IN_PLAY){
            document.getElementById('targets-made').hidden = true;
            document.getElementById('not-started').hidden = true;
            document.getElementById('in-play').hidden = false;
            // console.log("time left: " + gameState.timeLeft/1000);
            var targetElement = document.getElementById('target');
            targetElement.innerText = "Target: " + gameState.userList
            [gameState.targets[publicId]].username;
            document.getElementById('time-left').innerText = gameState.timeLeft / 1000;
          }
        }

        var gameState;
        var NOT_STARTED = "NOT STARTED";
        var TARGETS_MADE = "TARGETS MADE";
        var IN_PLAY = "IN PLAY";

        document.getElementById('make-targets').onclick = function(event){
          socket.emit('make targets');
        }

        document.getElementById('start-game').onclick = function(event){
          var gameLength = document.getElementById('game-length').value;
          socket.emit('start game', { gameLength: gameLength });
        }

        document.getElementById('stop-game').onclick = function(event){
          // todo: add confirmation dialogue
          socket.emit('stop game');
        }

        socket.on('update state', function(msg){
          gameState = msg.gameState;
          processGameStateChange(gameState);
          if(msg.botMessage){
            newMessageEntry(gameId, 'Gamebot3000', msg.botMessage);
          }
        });

        socket.on('New user', function(msg){
          gameState = msg.gameState;
          // msg needs to tell us which new user joined
          newUser = gameState.userList[msg.publicId].username;
          newMessageEntry(gameId, 'Gamebot3000', 'New user joined: ' + newUser);
          processGameStateChange(gameState);
        });

        socket.on('timeLeft', function(msg){
          gameState = msg.gameState;
          processGameStateChange(gameState);
        });

        socket.on('chat message', function(msg){
          console.log(msg);
          gameState = msg.gameState;
          username = gameState.userList[msg.publicId].username;
          newMessageEntry(gameId, username, msg.text, msg.image)
          processGameStateChange(gameState);

          if(msg.botMessage){
            newMessageEntry(gameId, 'Gamebot3000', msg.botMessage);
          }

          //if we're scrolled to the bottom of messages, stick to the bottom
          messages = document.getElementById('messages')
          // if(messages.scrollTop == (messages.scrollHeight - messages.offsetHeight)){
            messages.scrollTo(0, messages.scrollHeight)
          // }
        });
        var photo = document.getElementById('photo');
      };
    </script>
  </body>
</html>
