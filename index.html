<!doctype html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <style>
      body {
        font-size: 2em;
      }
      /* * { margin: 0; padding: 0; box-sizing: border-box; } */
      #messages {
        list-style-type: none;
        /* margin: 0;
        padding: 0; */
        overflow-y: scroll;
        height: 60vh;
        }
      form {
        display: table;
        background: #4eb7e7;
        width: 100%;
        /* position: fixed; */
        bottom: 0;
      }
      #messages li:nth-child(odd) { background: #eee; }
      .username {
        font-weight: bold;
      }
      #message {
        width: 100%;
      }

      button, input, textarea {
        font-size: larger;
      }

      button, label, textarea {
        display: block;
      }

      img {
        width: 80vw;
        height: 80vw;
        object-fit: cover; /* Do not scale the image */
        object-position: center; /* Center the image within the element */
      }
    </style>
  </head>
  <body>
    <!--todo: use semantic elements-->
    <div id="not-started">
      <p id="username"></p><button>Make targets</button>
    </div>
    <div id="targets-made" hidden>
        <p id="username"></p><button>Start</button>
        <ul id="targets"></ul>
        <input id="game-length">
    </div>
    <div id="in-play" hidden>
        <p id="username"></p>
        <p id="time-left"></p>
        <button>Stop</button>
        <p id="target"></p>
    </div>
    <ul id="messages"></ul>
    <form action="">
      <label>message
        <textarea id="message" placeholder="Type a message"></textarea>
      </label>
      <label>photo
          <input id="photo" type="file" accept="image/*" capture="camera">
      </label>
      <button id="send-message">Send</button>
    </form>
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
      var position = {latitude: null, longitude: null};
      function updatePosition(geolocation){
        position.latitude = geolocation.coords.latitude;
        position.longitude = geolocation.coords.longitude;
      }
      function dontUpdatePosition(a){
        console.log("geo loc failed");
        console.log(a);
      }

      $(function () {

        navigator.geolocation.watchPosition(
          updatePosition,
          dontUpdatePosition,
          {"enableHighAccuracy": true}
        );

        // gameId needs to be decoded because it contains a '/'
        // which gets URI encoded otherwise
        var gameId = decodeURIComponent(document.cookie.replace(/(?:(?:^|.*;\s*)gameId\s*\=\s*([^;]*).*$)|^.*$/, "$1"));
        var privateId = document.cookie.replace(/(?:(?:^|.*;\s*)privateId\s*\=\s*([^;]*).*$)|^.*$/, "$1");
        var publicId = document.cookie.replace(/(?:(?:^|.*;\s*)publicId\s*\=\s*([^;]*).*$)|^.*$/, "$1");
        console.log(gameId);
        const socket = io(
          // leading slash is needed so IO nows we're giving it a path
          // otherwise it uses it as a domain
          `/${gameId}`,
          {
            query: {
              "privateId": privateId,
            }
          });

        $('form').submit(function(){
          var file = document.getElementById('photo').files[0];
          message = {
            "text": $('#message').val(),
            "image": file,
            "position": position
          }
          socket.emit('chat message', message);
          $('#message').val('');
          document.getElementById('photo').value = '';
          return false;
        });
        function targetDisplay(targets){
          users = Object.keys(targets);
          output = "";
          for(var i=0; i<users.length;i++){
            output += users[i] + "-> " + targets[users[i]] + "\n";
          }
          return output

        }

        function processGameStateChange(gameState){
          if(gameState.state == TARGETS_MADE){
            console.log(targetDisplay(gameState.targets))
          }
          if(gameState.state ==  NOT_STARTED && gameState.winner){
            console.log("winner was " + gameState.winner);
          }
          if(gameState.state == IN_PLAY){
            console.log("time left: " + gameState.timeLeft/1000);
          }
        }

        var gameState;
        var NOT_STARTED = "NOT STARTED";
        var TARGETS_MADE = "TARGETS MADE";
        var IN_PLAY = "IN PLAY";
        socket.on('New user', function(msg){
          gameState = msg.gameState;
          document.getElementById('username').innerText = gameState.userList[publicId].username;
          console.log("new user");
          console.log(msg);
          processGameStateChange(gameState);
        });

        socket.on('timeLeft', function(msg){
          gameState == msg.gameState;
          processGameStateChange(gameState);
        });

        socket.on('chat message', function(msg){
          console.log(msg);
          var li = $('<li>');
          gameState = msg.gameState;
          sentFrom = gameState.userList[msg.publicId].username;
          var username = $("<span>").text(sentFrom);
          username.addClass("username");
          li.append(username);
          li.append($("<p>").text(msg.text));
          $('#messages').append(li);
          if(msg.image){
            var blob = new Blob([msg.image], {type: 'image/png'});
            var url = URL.createObjectURL(blob);
            var img = new Image;
            var canvas = document.createElement('canvas');
            img.src = url;
            li.append(img)
          }
          processGameStateChange(gameState);

          //if we're scrolled to the bottom of messages, stick to the bottom
          messages = document.getElementById('messages')
          // if(messages.scrollTop == (messages.scrollHeight - messages.offsetHeight)){
            messages.scrollTo(0, messages.scrollHeight)
          // }
        });
        var photo = document.getElementById('photo');
      });
    </script>
  </body>
</html>
